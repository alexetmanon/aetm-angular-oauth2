!function(){"use strict";angular.module("aetm-oauth2",["LocalStorageModule"]).config(["localStorageServiceProvider",function(e){e.setPrefix("aetm")}]).provider("aetmOAuth2Service",[function(){var e=this;e.apiBase="",e.apiOAuth2Endpoint="/oauth/v2/token",e.apiAuthorizationHeaderPrefix="Bearer",e.apiClientId="",e.apiClientSecret="",e.googleAppId="",e.googleScopes=["profile","email"],e.facebookScopes=["email"],e.configure=function(t){if(!t)throw"Options object required !";e.apiBase=t.apiBase||e.apiBase,e.apiOAuth2Endpoint=t.apiOAuth2Endpoint||e.apiOAuth2Endpoint,e.apiAuthorizationHeaderPrefix=t.apiAuthorizationHeaderPrefix||e.apiAuthorizationHeaderPrefix,e.apiClientId=t.apiClientId||e.apiClientId,e.apiClientSecret=t.apiClientSecret||e.apiClientSecret,e.googleAppId=t.googleAppId||e.googleAppId,e.googleScopes=t.googleScopes||e.googleScopes,e.facebookScopes=t.facebookScopes||e.facebookScopes},this.$get=["$q","$http","$log","$window","$rootScope","localStorageService",function(t,o,n,a,i,r){function c(e,t){I.accessToken=e.access_token,I.type=t,o.defaults.headers.common.Authorization=b+" "+I.accessToken,s(t,e)}function s(e,t){r.set(w,{type:e,oauthResponse:t})}function u(){r.remove(w)}function l(e,t){return i.$broadcast("aetm-oauth2:login:start"),o.post(k+m,{grant_type:"refresh_token",client_id:S,client_secret:A,refresh_token:e}).then(function(e){return c(e.data,t),i.$broadcast("aetm-oauth2:login:end"),e},function(e){throw n.debug("API connection error",e),i.$broadcast("aetm-oauth2:login:end"),e})}function p(){var e=t.defer();return facebookConnectPlugin.getLoginStatus(function(t){return"connected"===t.status&&t.authResponse&&t.authResponse.accessToken?void e.resolve(t.authResponse.accessToken):void facebookConnectPlugin.login($,function(t){t.authResponse&&t.authResponse.accessToken?e.resolve(t.authResponse.accessToken):e.reject(t)},e.reject)},e.reject),e.promise}function d(){var e=t.defer();return a.plugins.googleplus.login({scopes:v.join(" "),webClientId:_,offline:!0},function(t){t.idToken?e.resolve(t.idToken):e.reject(t)},e.reject),e.promise}function f(e){return o.post(k+m,{grant_type:"http://platform.local/grants/facebook_access_token",client_id:S,client_secret:A,accessToken:e}).then(function(e){return c(e.data,"facebook"),e},function(e){throw n.debug("API connection error",e),e})}function g(e){return o.post(k+m,{grant_type:"http://platform.local/grants/google_access_token",client_id:S,client_secret:A,accessToken:e}).then(function(e){return c(e.data,"google"),e},function(e){throw n.debug("API connection error",e),e})}function h(e){return e&&e.email&&e.password?o.post(k+m,{grant_type:"password",client_id:S,client_secret:A,username:e.email,password:e.password}).then(function(e){return c(e.data,"email"),e},function(e){throw n.debug("API connection error",e),e}):t.reject('Missing credentials. "email" and "password" required.')}var k=e.apiBase,m=e.apiOAuth2Endpoint,b=e.apiAuthorizationHeaderPrefix,S=e.apiClientId,A=e.apiClientSecret,_=e.googleAppId,v=e.googleScopes,$=e.facebookScopes,w="aetmAuthStorage",I={accessToken:null,type:null};return I.loginFacebook=function(){var e;return i.$broadcast("aetm-oauth2:login:start"),e=p().then(function(e){return f(e)}),e["finally"](function(){i.$broadcast("aetm-oauth2:login:end")}),e},I.loginGoogle=function(){var e;return i.$broadcast("aetm-oauth2:login:start"),e=d().then(function(e){return g(e)}),e["finally"](function(){i.$broadcast("aetm-oauth2:login:end")}),e},I.loginEmail=function(e){var t;return i.$broadcast("aetm-oauth2:login:start"),t=h(e),t["finally"](function(){i.$broadcast("aetm-oauth2:login:end")}),t},I.isConnected=function(){return!!I.accessToken},I.getType=function(){return I.type},I.hasLoginStored=function(){var e=r.get(w);return e&&e.oauthResponse&&e.oauthResponse.access_token},I.checkLoginStatus=function(){var e=r.get(w);return e&&e.oauthResponse&&e.oauthResponse.access_token?l(e.oauthResponse.refresh_token,e.type).then(function(e){return e.data&&e.data.access_token?{status:"connected"}:{status:"unknown"}},function(e){if(e&&e.data&&"invalid_grant"===e.data.error)return{status:"disconnected"};throw e}):t.resolve({status:"disconnected"})},I.logout=function(){I={},delete o.defaults.headers.common.Authorization,u(),i.$broadcast("aetm-oauth2:logout")},I.updateRequest=function(e){return e.headers.Authorization=o.defaults.headers.common.Authorization,e},I}]}])}();