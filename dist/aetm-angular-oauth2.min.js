!function(){"use strict";angular.module("aetm-oauth2",["LocalStorageModule"]).config(["localStorageServiceProvider",function(e){e.setPrefix("aetm")}]).provider("aetmOAuth2Service",[function(){var e=this;e.apiBase="",e.apiClientId="",e.apiClientSecret="",e.googleAppId="",e.configure=function(t){e.apiBase=t.apiBase||"",e.apiClientId=t.apiClientId||"",e.apiClientSecret=t.apiClientSecret||"",e.googleAppId=t.googleAppId||""},this.$get=["$q","$http","$log","localStorageService","$window","$rootScope",function(t,n,o,a,r,c){function i(e,t){v.accessToken=e.access_token,v.type=t,n.defaults.headers.common.Authorization="Bearer "+v.accessToken,s(t,e)}function s(e,t){a.set(_,{type:e,oauthResponse:t})}function u(){a.remove(_)}function l(e,t){return c.$broadcast("aetm-oauth2:login:start"),n.post(g+"/oauth/v2/token",{grant_type:"refresh_token",client_id:h,client_secret:m,refresh_token:e}).then(function(e){return i(e.data,t),c.$broadcast("aetm-oauth2:login:end"),e},function(e){return o.error("API connection error",e),c.$broadcast("aetm-oauth2:login:end"),e})}function p(e){return n.post(g+"/oauth/v2/token",{grant_type:"http://platform.local/grants/facebook_access_token",client_id:h,client_secret:m,accessToken:e}).then(function(e){return i(e.data,"facebook"),e},function(e){return o.error("API connection error",e),e})}function f(e){return n.post(g+"/oauth/v2/token",{grant_type:"http://platform.local/grants/google_access_token",client_id:h,client_secret:m,accessToken:e}).then(function(e){return i(e.data,"google"),e},function(e){return o.error("API connection error",e),e})}function d(e){return e&&e.email&&e.password?n.post(g+"/oauth/v2/token",{grant_type:"password",client_id:h,client_secret:m,username:e.email,password:e.password}).then(function(e){return i(e.data,"email"),e},function(e){return o.error("API connection error",e),e}):t.reject('Missing credentials. "email" and "password" required.')}var g=e.apiBase,h=e.apiClientId,m=e.apiClientSecret,k=e.googleAppId,_="aetmAuthStorage",v={accessToken:null,type:null};return v.loginFacebook=function(){var e=t.defer();return c.$broadcast("aetm-oauth2:login:start"),facebookConnectPlugin.login(["email"],function(t){t.authResponse&&t.authResponse.accessToken?p(t.authResponse.accessToken).then(function(t){e.resolve(t)},function(t){e.reject(t)}):e.reject(t)},function(t){e.reject(t)}),e.promise["finally"](function(){c.$broadcast("aetm-oauth2:login:end")}),e.promise},v.loginGoogle=function(){var e=t.defer();return c.$broadcast("aetm-oauth2:login:start"),r.plugins.googleplus.login({scopes:"profile email",webClientId:k,offline:!0},function(t){t.idToken?f(t.idToken).then(function(t){e.resolve(t)},function(t){e.reject(t)}):e.reject(t)},function(t){e.reject(t)}),e.promise["finally"](function(){c.$broadcast("aetm-oauth2:login:end")}),e.promise},v.loginEmail=function(e){var t;return c.$broadcast("aetm-oauth2:login:start"),t=d(e),t["finally"](function(){c.$broadcast("aetm-oauth2:login:end")}),t},v.isConnected=function(){return!!v.accessToken},v.getType=function(){return v.type},v.checkLoginStatus=function(){var e=a.get(_);return e&&e.oauthResponse&&e.oauthResponse.access_token?l(e.oauthResponse.refresh_token,e.type).then(function(e){return e.data&&e.data.access_token?{status:"connected"}:{status:"unknown"}}):t.resolve({status:"disconnected"})},v.logout=function(){v={},delete n.defaults.headers.common.Authorization,u()},v}]}])}();