!function(){"use strict";angular.module("aetm-oauth2",["LocalStorageModule"]).config(["localStorageServiceProvider",function(e){e.setPrefix("aetm")}]).provider("aetmOAuth2Service",[function(){var e=this;e.apiBase="",e.apiClientId="",e.apiClientSecret="",e.googleAppId="",e.configure=function(t){e.apiBase=t.apiBase||"",e.apiClientId=t.apiClientId||"",e.apiClientSecret=t.apiClientSecret||"",e.googleAppId=t.googleAppId||""},this.$get=["$q","$http","$log","$window","$rootScope","localStorageService",function(t,n,o,a,r,c){function i(e,t){$.accessToken=e.access_token,$.type=t,n.defaults.headers.common.Authorization="Bearer "+$.accessToken,s(t,e)}function s(e,t){c.set(b,{type:e,oauthResponse:t})}function u(){c.remove(b)}function l(e,t){return r.$broadcast("aetm-oauth2:login:start"),n.post(m+"/oauth/v2/token",{grant_type:"refresh_token",client_id:k,client_secret:v,refresh_token:e}).then(function(e){return i(e.data,t),r.$broadcast("aetm-oauth2:login:end"),e},function(e){throw o.debug("API connection error",e),r.$broadcast("aetm-oauth2:login:end"),e})}function d(){var e=t.defer();return facebookConnectPlugin.getLoginStatus(function(t){return"connected"===t.status&&t.authResponse&&t.authResponse.accessToken?void e.resolve(t.authResponse.accessToken):void facebookConnectPlugin.login(["email"],function(t){t.authResponse&&t.authResponse.accessToken?e.resolve(t.authResponse.accessToken):e.reject(t)},e.reject)},e.reject),e.promise}function f(){var e=t.defer();return a.plugins.googleplus.login({scopes:"profile email",webClientId:_,offline:!0},function(t){t.idToken?e.resolve(t.idToken):e.reject(t)},e.reject),e.promise}function p(e){return n.post(m+"/oauth/v2/token",{grant_type:"http://platform.local/grants/facebook_access_token",client_id:k,client_secret:v,accessToken:e}).then(function(e){return i(e.data,"facebook"),e},function(e){throw o.debug("API connection error",e),e})}function g(e){return n.post(m+"/oauth/v2/token",{grant_type:"http://platform.local/grants/google_access_token",client_id:k,client_secret:v,accessToken:e}).then(function(e){return i(e.data,"google"),e},function(e){throw o.debug("API connection error",e),e})}function h(e){return e&&e.email&&e.password?n.post(m+"/oauth/v2/token",{grant_type:"password",client_id:k,client_secret:v,username:e.email,password:e.password}).then(function(e){return i(e.data,"email"),e},function(e){throw o.debug("API connection error",e),e}):t.reject('Missing credentials. "email" and "password" required.')}var m=e.apiBase,k=e.apiClientId,v=e.apiClientSecret,_=e.googleAppId,b="aetmAuthStorage",$={accessToken:null,type:null};return $.loginFacebook=function(){var e;return r.$broadcast("aetm-oauth2:login:start"),e=d().then(function(e){return p(e)}),e["finally"](function(){r.$broadcast("aetm-oauth2:login:end")}),e},$.loginGoogle=function(){var e;return r.$broadcast("aetm-oauth2:login:start"),e=f().then(function(e){return g(e)}),e["finally"](function(){r.$broadcast("aetm-oauth2:login:end")}),e},$.loginEmail=function(e){var t;return r.$broadcast("aetm-oauth2:login:start"),t=h(e),t["finally"](function(){r.$broadcast("aetm-oauth2:login:end")}),t},$.isConnected=function(){return!!$.accessToken},$.getType=function(){return $.type},$.hasLoginStored=function(){var e=c.get(b);return e&&e.oauthResponse&&e.oauthResponse.access_token},$.checkLoginStatus=function(){var e=c.get(b);return e&&e.oauthResponse&&e.oauthResponse.access_token?l(e.oauthResponse.refresh_token,e.type).then(function(e){return e.data&&e.data.access_token?{status:"connected"}:{status:"unknown"}},function(e){if(e&&e.data&&"invalid_grant"===e.data.error)return{status:"disconnected"};throw e}):t.resolve({status:"disconnected"})},$.logout=function(){$={},delete n.defaults.headers.common.Authorization,u(),r.$broadcast("aetm-oauth2:logout")},$.updateRequest=function(e){return e.headers.Authorization=n.defaults.headers.common.Authorization,e},$}]}])}();