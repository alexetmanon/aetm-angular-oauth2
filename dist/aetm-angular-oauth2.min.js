!function(){"use strict";angular.module("aetm-oauth2",["LocalStorageModule"]).config(["localStorageServiceProvider",function(e){e.setPrefix("aetm")}]).provider("aetmOAuth2Service",[function(){var e=this;e.apiBase="",e.apiOAuth2Endpoint="/oauth/v2/token",e.apiAuthorizationHeaderPrefix="Bearer",e.apiClientId="",e.apiClientSecret="",e.googleAppId="",e.googleScopes=["profile","email"],e.facebookScopes=["email"],e.configure=function(t){if(!t)throw"Options object required !";e.apiBase=t.apiBase||e.apiBase,e.apiOAuth2Endpoint=t.apiOAuth2Endpoint||e.apiOAuth2Endpoint,e.apiAuthorizationHeaderPrefix=t.apiAuthorizationHeaderPrefix||e.apiAuthorizationHeaderPrefix,e.apiClientId=t.apiClientId||e.apiClientId,e.apiClientSecret=t.apiClientSecret||e.apiClientSecret,e.googleAppId=t.googleAppId||e.googleAppId,e.googleScopes=t.googleScopes||e.googleScopes,e.facebookScopes=t.facebookScopes||e.facebookScopes},this.$get=["$q","$http","$log","$window","$rootScope","localStorageService",function(t,o,n,a,i,r){function c(e,t){y.accessToken=e.access_token,y.type=t,o.defaults.headers.common.Authorization=v+" "+y.accessToken,s(t,e)}function s(e,t){r.set(w,{type:e,oauthResponse:t})}function u(){r.remove(w)}function d(e,t){return i.$broadcast("aetm-oauth2:login:start"),o.post(m+k,{grant_type:"refresh_token",client_id:b,client_secret:S,refresh_token:e}).then(function(e){return c(e.data,t),i.$broadcast("aetm-oauth2:login:end"),e},function(e){throw n.debug("API connection error",e),i.$broadcast("aetm-oauth2:login:end"),e})}function l(){var e=t.defer();return document.addEventListener("deviceready",function(){facebookConnectPlugin.getLoginStatus(function(t){return"connected"===t.status&&t.authResponse&&t.authResponse.accessToken?void e.resolve(t.authResponse.accessToken):void facebookConnectPlugin.login($,function(t){t.authResponse&&t.authResponse.accessToken?e.resolve(t.authResponse.accessToken):e.reject(t)},e.reject)},e.reject)},!1),e.promise}function p(){var e=t.defer();return document.addEventListener("deviceready",function(){a.plugins.googleplus.login({scopes:_.join(" "),webClientId:A,offline:!0},function(t){t.idToken?e.resolve(t.idToken):e.reject(t)},e.reject)},!1),e.promise}function f(e){return o.post(m+k,{grant_type:"http://platform.local/grants/facebook_access_token",client_id:b,client_secret:S,accessToken:e}).then(function(e){return c(e.data,"facebook"),e},function(e){throw n.debug("API connection error",e),e})}function g(e){return o.post(m+k,{grant_type:"http://platform.local/grants/google_access_token",client_id:b,client_secret:S,accessToken:e}).then(function(e){return c(e.data,"google"),e},function(e){throw n.debug("API connection error",e),e})}function h(e){return e&&e.email&&e.password?o.post(m+k,{grant_type:"password",client_id:b,client_secret:S,username:e.email,password:e.password}).then(function(e){return c(e.data,"email"),e},function(e){throw n.debug("API connection error",e),e}):t.reject('Missing credentials. "email" and "password" required.')}var m=e.apiBase,k=e.apiOAuth2Endpoint,v=e.apiAuthorizationHeaderPrefix,b=e.apiClientId,S=e.apiClientSecret,A=e.googleAppId,_=e.googleScopes,$=e.facebookScopes,w="aetmAuthStorage",y={accessToken:null,type:null};return y.loginFacebook=function(){var e;return i.$broadcast("aetm-oauth2:login:start"),e=l().then(function(e){return f(e)}),e["finally"](function(){i.$broadcast("aetm-oauth2:login:end")}),e},y.loginGoogle=function(){var e;return i.$broadcast("aetm-oauth2:login:start"),e=p().then(function(e){return g(e)}),e["finally"](function(){i.$broadcast("aetm-oauth2:login:end")}),e},y.loginEmail=function(e){var t;return i.$broadcast("aetm-oauth2:login:start"),t=h(e),t["finally"](function(){i.$broadcast("aetm-oauth2:login:end")}),t},y.isConnected=function(){return!!y.accessToken},y.getType=function(){return y.type},y.hasLoginStored=function(){var e=r.get(w);return e&&e.oauthResponse&&e.oauthResponse.access_token},y.checkLoginStatus=function(){var e=r.get(w);return e&&e.oauthResponse&&e.oauthResponse.access_token?d(e.oauthResponse.refresh_token,e.type).then(function(e){return e.data&&e.data.access_token?{status:"connected"}:{status:"unknown"}},function(e){if(e&&e.data&&"invalid_grant"===e.data.error)return{status:"disconnected"};throw e}):t.resolve({status:"disconnected"})},y.logout=function(){y={},delete o.defaults.headers.common.Authorization,u(),i.$broadcast("aetm-oauth2:logout")},y.updateRequest=function(e){return e.headers.Authorization=o.defaults.headers.common.Authorization,e},y}]}])}();